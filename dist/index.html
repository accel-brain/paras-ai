// 最新投稿順でページを取得する関数
function getRecentPages() {
    if (!currentData || !currentData.sort_dict) {
        return [];
    }
    
    // sort_dictからタイムスタンプ順でソート
    const sortedPages = Object.keys(currentData.sort_dict)
        .map(filePath => ({
            file_path: filePath,
            publish_timestamp: currentData.sort_dict[filePath].publish_timestamp,
            publish_datetime: currentData.sort_dict[filePath].publish_datetime
        }))
        .sort((a, b) => b.publish_timestamp - a.publish_timestamp); // 降順（最新順）
    
    return sortedPages;
}

// 最新投稿順の結果を表示する関数
function displayRecentPosts() {
    if (!currentData) {
        return;
    }
    
    const recentPages = getRecentPages();
    const resultsGrid = document.getElementById('resultsGrid');
    const resultsCount = document.getElementById('resultsCount');
    const noResults = document.getElementById('noResults');
    
    resultsCount.textContent = `最新の投稿: ${recentPages.length}件`;
    
    if (recentPages.length === 0) {
        resultsGrid.innerHTML = '';
        noResults.style.display = 'block';
        return;
    }

    noResults.style.display = 'none';
    
    resultsGrid.innerHTML = recentPages.map(page => {
        const title = currentData.page_title_dict[page.file_path] || page.file_path;
        const topKeywords = getTopKeywordsForPath(page.file_path);
        const publishDate = page.publish_datetime ? 
            new Date(page.publish_datetime).toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : '';
        
        return `
            <a href="${page.file_path}" class="result-card">
                <div class="result-title">${title}</div>
                ${publishDate ? `<div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">${publishDate}</div>` : ''}
                <div class="result-keywords">
                    ${topKeywords.map(kw => `<span class="keyword-tag" onclick="searchByKeywordTag(event, '${kw}')">${kw}</span>`).join('')}
                </div>
            </a>
        `;
    }).join('');
}

// 初期表示時または検索キーワードが空の場合の処理を追加する関数
function handleInitialOrEmptySearch() {
    const searchInput = document.getElementById('searchInput');
    const keyword = searchInput ? searchInput.value.trim() : '';
    
    if (!keyword) {
        // キーワードが空の場合は最新投稿順で表示
        displayRecentPosts();
        return true;
    }
    
    return false;
}

// 既存のperformSearch関数を拡張するためのラッパー関数
function enhancedPerformSearch() {
    // 空の検索の場合は最新投稿順で表示
    if (handleInitialOrEmptySearch()) {
        return;
    }
    
    // 既存の検索処理を実行
    performSearch();
}

// 既存のexecuteKeywordSearch関数を拡張するためのラッパー関数
function enhancedExecuteKeywordSearch(keyword) {
    if (!keyword || !keyword.trim()) {
        // キーワードが空の場合は最新投稿順で表示
        displayRecentPosts();
        return;
    }
    
    // 既存の検索処理を実行
    executeKeywordSearch(keyword);
}

// アプリケーション初期化時に最新投稿を表示する関数
function displayInitialContent() {
    if (currentData && currentData.sort_dict) {
        displayRecentPosts();
    }
}

// 既存のupdateResultsCount関数を拡張
function enhancedUpdateResultsCount() {
    updateResultsCount();
    // 初期化完了後に最新投稿を表示
    setTimeout(displayInitialContent, 100);
}

// イベントリスナーの置き換え
document.addEventListener('DOMContentLoaded', function() {
    // 検索ボタンのイベントリスナーを上書き
    const searchButton = document.querySelector('.search-button');
    if (searchButton) {
        // 既存のonclick属性を削除して新しいイベントリスナーを設定
        searchButton.removeAttribute('onclick');
        searchButton.addEventListener('click', enhancedPerformSearch);
    }
    
    // Enterキーのイベントリスナーも更新
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        // 既存のイベントリスナーを削除
        searchInput.removeEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        
        // 新しいイベントリスナーを追加
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                enhancedPerformSearch();
            }
        });
    }
});

// 既存のinitializeApp関数の後に実行される初期化処理
function enhancedInitialization() {
    // データ読み込み完了をチェック
    const checkDataAndDisplay = setInterval(() => {
        if (currentData && currentData.sort_dict && currentData.page_title_dict) {
            clearInterval(checkDataAndDisplay);
            
            // URLハッシュにキーワードがない場合は最新投稿を表示
            const hash = window.location.hash;
            if (!hash.startsWith('#keyword=')) {
                setTimeout(displayInitialContent, 500);
            }
        }
    }, 100);
    
    // 10秒でタイムアウト
    setTimeout(() => {
        clearInterval(checkDataAndDisplay);
    }, 10000);
}

// 拡張初期化を実行
enhancedInitialization();
